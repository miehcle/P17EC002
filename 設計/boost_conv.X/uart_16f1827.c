
/* uart_16f1827.c
 * UART?????????
 *
 * Auther : TSUCHIYA Yosuke
 * Created on : 2015/06/23 0:18
 */

//#include <xc.h>

#include "uart_16f1827.h"
#include "system_config.h"

struct txbuffer u1txbuff;	//u1txbuff??????????


/*UART????????
 *
 *
 */
void UART_Init(void){
	//???????
	BRGH = 1;	//0:????? 1:?????
	SPBRGH = 0;	//
	SPBRGL = 103;
	//SPBRGL = 64;
	//SPBRGL = 32;	//Fosc = 32MHz, 57600bps
	//SPBRGL = 16;	//Fosc = 32MHz,115200bps
	//SPBRGL = 8;	//Fosc = 16MHz,115200bps
	//???????
	BRG16 = 0;	//16bit???????
	SYNC = 0;	//?????(UART)
	SPEN = 1;	//??????????
	TX9 = 0;	//8bit?????
	TXEN = 1;	//??????
	SENDB = 0;	//?????????????
    //????
    APFCON1bits.TXCKSEL = 0;    //TX????? 0:RB2, 1:RB5
	TRISBbits.TRISB2 = 1;	//????
    
	//??
    APFCON0bits.RXDTSEL = 0;    //RX????? 0:RB1, 1:RB2
	TRISBbits.TRISB1 = 1;	//RX????????
    ANSELBbits.ANSB1 = 0;   //???????    ANSEL?????TRIS?????????????????????
	CREN = 1;	//?????
    
    //??????
    //TXIE = 1;   //?????????
    RCIE = 1;   //?????????
    PEIE = 1;   //????????????
    GIE = 1;    //???????????
    
    //????????
    u1txbuff.head = 0;
    u1txbuff.end = 0;


}

void putc_UART(unsigned char data){
	//RB3 = 1;
    TXIE = 0;   //???????
    //while(!TRMT);	//??????????????? TRMT = 1??????????24F??????
    while(!TXIF);
    //RB3 = 0;
	TXREG = data;	//??????????????
}


/* ??????????????????????
 *
 * 
 */
void puts_UART(char *str){
    unsigned char txie;
    txie = TXIE;
    TXIE = 0;
    while(*str != 0){
        putc_UART(*str);    //???????
        str++;  //???
    }
    TXIE = txie;
}


/* ??????(????)????????
 * 
 * 
 */
void puts_UARTb(char *str){
    //RB3 = 1;
    while(*str != 0){
        set_data_buff(*str);    //???????
        str++;  //???
    }
    TXIE = 1;
    //RB3 = 0;
}



/*
 *
 *
 */

void set_data_buff(unsigned char data){
    TXIE = 0;
	u1txbuff.txdata[u1txbuff.end] = data;   //???????????
    
    u1txbuff.end++; //???????
    if(u1txbuff.end >= BUFF_SIZE){
        u1txbuff.end = 0;
    }
    if(u1txbuff.end == u1txbuff.head){
    //if(u1txbuff.end >= BUFF_SIZE){  //?????????????????
    //if(u1txbuff.end == 255){  //????????? = ?????????????
        puts_UART("\r\nTX speed over!\r\n");
        u1txbuff.end--;
        //puts_UART(" head:");
        //putdec_UART(u1txbuff.head);
        //puts_UART("end:");
        //putdec_UART(u1txbuff.end);
    }
    //TXIE = 1;   //????????? = ?????
}

void putdec_UARTb(int dec){
    
    //unsigned int _dec;
    unsigned int cnt = 0;   //?????
    int i;
    unsigned char dec_buff[10] = {0};
    if(dec < 0){    //????????????
        set_data_buff('-');
        dec *= -1;
    }
    
    /*
    while((unsigned int)dec/(cnt * 10)  > 0){   //??????
        cnt++;
    }
    
    for(i = cnt; i > 0; i--){
        dec_buff[i] = dec/(i * );
    }
    */
    if(dec == 0){
        set_data_buff('0');
    }
    while(dec != 0){ //?????????
        dec_buff[cnt] = dec % 10;   //????????
        dec /= 10;
        cnt++;
    }
    for(i = cnt - 1; i >= 0; i--){
        set_data_buff(dec_buff[i] + 48); //???????????????
    }
    TXIE = 1;
    //RB3 = 1;
}

//??????????????
void putdec_UART(int dec){
    unsigned char txie;
    txie = TXIE;
    TXIE = 0;
    //unsigned int _dec;
    unsigned int cnt = 0;   //?????
    int i;
    unsigned char dec_buff[10] = {0};
    if(dec < 0){    //????????????
        putc_UART('-');
        dec *= -1;
    }
    
    /*
    while((unsigned int)dec/(cnt * 10)  > 0){   //??????
        cnt++;
    }
    
    for(i = cnt; i > 0; i--){
        dec_buff[i] = dec/(i * );
    }
    */
    if(dec == 0){
        putc_UART('0');
    }
    while(dec != 0){ //?????????
        dec_buff[cnt] = dec % 10;   //????????
        dec /= 10;
        cnt++;
    }
    for(i = cnt - 1; i >= 0; i--){
        putc_UART(dec_buff[i] + 48); //???????
    }
    TXIE = txie;
    //RB3 = 1;
}